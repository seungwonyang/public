<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<!-- 	Project: ProVis: Progressive Disclosure Visualization
		Name: Seungwon Yang
		Date: 8/14/2012
		Description: prototype tool for the ProVis project	
-->

<head>

	<title>Provis Layout Demo</title>

	<link type="text/css" rel="Stylesheet" href="http://ajax.aspnetcdn.com/ajax/jquery.ui/1.8.10/themes/redmond/jquery-ui.css" />

	<!-- Include an external stylesheet -->
	<link type="text/css" rel="Stylesheet" href="provis.css" />

	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/jquery-ui.min.js"></script>
	<script type="text/javascript" src="jquery.layout.js"></script>
	<script type="text/javascript" src="js/complex.js"></script>
    <script src="../d3/d3.v2.js"></script>
	<script type="text/javascript">

	var myLayout; // a var is required because this page utilizes: myLayout.allowOverflow() method

	// it allows the html document to be completely downloaded.
	$(document).ready(function () {
		myLayout = $('body').layout({
			// enable showOverflow on west-pane so popups will overlap north pane
			west__showOverflowOnHover: true,
		});
		// myLayout.sizePane("east", 340);
		myLayout.sizePane("east", 275);
		myLayout.sizePane("west", 750);
 	});
	</script>

</head>
<body>
<!-- ui-layout-west is the most outer frame of visualization pane -->
<div class="ui-layout-west">
	<div  id="topBoxWest" class="topBox">

    	<!-- two radio check marks to select type of metadata -->
    	<label><input type="radio" name="radio2" id="opencalaisRadio" class="radioButton">Opencalais metadata</label>
    	<label><input type="radio" name="radio2" id="manualRadio" class="radioButton">Manual metadata</label>
    	

		<!-- <h3>ProVis</h3> -->
		<!-- <button id="regraph" style="">Regraph</button> -->
		<button id="removeTopics" style="">Clear Corel</button>
	</div>

	<div id="head1" class="corelHead">CORE</div>
<!-- 	<div id="head2" class="corelHead">RELATED</div>
 -->
	<!-- sortableDemo div contains two rolws of Corel -->
	<div class="sortableDemo">
		<!-- Core cells -->
		<div id="parent1" class="corelGrid">
			<div id="1_1" class="corelCell" contentEditable="true"></div>
			<div id="1_2" class="corelCell" contentEditable="true"></div>
			<div id="1_3" class="corelCell" contentEditable="true"></div>
			<div id="1_4" class="corelCell" contentEditable="true"></div>
			<div id="1_5" class="corelCell" contentEditable="true"></div>
			<div id="1_6" class="corelCell" contentEditable="true"></div>

		</div>
	</div>
	
	<!-- Allow sorting of corel cells -->
	<script type="text/javascript" charset="utf-8">

		// make Core cells sortable
		$("#parent1").sortable({
			revert: true
		});
		// make Relevant cells sortable
		// $("#parent2").sortable({
		// 	revert: true
		// });

		</script>


	<div id="visDiv">
	</div>

</div>

<!-- Document content view pane -->
<div class="ui-layout-east">
    <div id="topBoxEast" class="topBox">

	</div>	
	<!-- content is written inside the div below -->
	<div id="singleText"></div>

</div>

<!-- Document list view pane -->
<div class="ui-layout-center" >

    <div id="topBoxCenter" class="topBox">
		<h3>ProVis</h3>
    </div>

    <!-- Configurations with default values -->
	<p>  
        <input id="numTopics" value="80" style="text-align:right;"/>topics to visualize
    </p>  
	<p>  
        <input id="articlesToList" value="10" style="text-align:right;"/>(%) articles to list
    </p>  
	<p>  
        <input id="relatedTopicsCut" value="30" style="text-align:right;"/>(%) related topics to link
	</p>  
    <div class="bumper" style="width:275px;height:10px;"></div>
    	<p id="totalNum"></p>
        <div class="bumper" style="width:275px;height:10px;"></div>
    

    <!-- Document list and tetris visualization are included in centerOuter -->
    <!-- <div id="centerMostOut"> -->
	    <div id="centerOuter">	    	
	    	<div id="results"></div>
	   		<div id="tetrisResults"></div>
	    	<div id="chickletResults"></div>
		</div>

	<!-- </div> -->
    <script type="text/javascript" charset="utf-8">

    var topic_max = 0; 
    var prevClickedNodeId = "";
    var prevRelated_topic_index = [];
    // dictionary to store docID and its barStat_r color
    var barStat_r_dict = {};
    // latest query word in corel cell
    var latestQuery = "";

    $('#manualRadio').attr("checked", "true");

		// The function below accepts two arrays a and b, each of which should be
		// sorted in advance.  It returns an intersection array of a and b.
		function intersection_arrays(a, b) {
			var ai = 0, bi = 0;
			var result = new Array();
			while(ai < a.length && bi < b.length) {
				if (a[ai] < b[bi]) {ai++;}
				else if (a[ai] > b[bi]) {bi++;}
				else { /* they are equal */
					result.push(a[ai]);
					ai++;
					bi++;
				}	
			}
			return result;
		}

		// This function simply returns a deduplicated array.
		function dedupe(list) {
		   
		   var tmpList = list;
		   var set = {};
		   for (var i = 0; i < tmpList.length; i++)
		      set[tmpList[i]] = true;
		   tmpList = [];
		   for (var topic in set)
		      tmpList.push(topic);
		   return tmpList;
		}

		// Main function to create a topic graph
    	function visualizeTopics_d3(docs) {
		    var dataset = {};
		    var uniqueTopicLi = [];
		    var uniqueWeightLi = [];
		    var topicTotal = 0;
		    var json_filename = "";
	  		var opencalais_filename = "topic_numDoc_relindex.json";
	  		var manual_filename = "topic_numDoc_relindex_orimet.json";
	  		// check whether 'Manual metadata' or 'Opencalais metadata' has a check mark
	  		var openManFlag = "";
		    if ($('#manualRadio').attr('checked') == true) {
		    	openManFlag = "manual";
		    	json_filename = manual_filename;
		    } else {
		    	openManFlag = "opencalais";
		    	json_filename = opencalais_filename;
		    }
		    // process each document in data to compute topic relationships
		    // json_filename has the topic relatedness relationship
			$.getJSON(json_filename, function(data) {
				var numDocsObj = data;
	        	var sortedDataset = [];
	    		// empty visDiv pane to get ready for new graph
	    		$('#visDiv').empty();
	    		// Loop through docs, count topics and find related docIDs
	    		$.each(docs, function(index, item) {
	    			// process each doc
	    			uniqueTopicLi = [];  // initialize uniqueTopicLi
	    			// use manual metadata in original NYT articles
	                if (openManFlag == "manual") {
		                // use 4 manual metadata fields from NYT article
		        		var descriptors = item.descriptors;
		        		var people = item.people;
		        		var locations = item.locations;
		        		var organizations = item.organizations;
		        		// arrays to hold entries from the 4 manual fields
		        		var topicLi = [];
		        		var descriptors_arr = [];
		        		var people_arr = [];
		        		var locations_arr = [];
		        		var organizations_arr = [];
		        		var merged_arr = [];
		        		// process only when the manual metadata field is not empty
		        		// and combine all 4 entries into a single 'merged_arr' array
		        		if ( descriptors != "") {
		        			merged_arr = $.merge([], descriptors.slice(1,-1).split('","'));
		        		}
		        		if ( people != "") {
		        			merged_arr = $.merge(merged_arr, people.slice(1,-1).split('","'));
		        		}
		        		if ( locations != "") {
		        			merged_arr = $.merge(merged_arr, locations.slice(1,-1).split('","'));
		        		}
		        		if ( organizations != "") {
		        			merged_arr = $.merge(merged_arr, organizations.slice(1,-1).split('","'));
		        		}
	 
		                // count num. of topics, keep docIDs from returned documents
		                // if (typeof opencalais != 'undefined') {
		                if (merged_arr != []) {
		                	// deduplicate the topics in merged_arr
		                	topicLi = dedupe(merged_arr);
		                	// ------- this is to compute local topic weights -----------
			               	for (var i=0; i < topicLi.length; i++) {
		                		//var topicElem = dataset[topicLi[i]];
		                		// adding a new topic
		                		if (!dataset[topicLi[i]]) {
		                			dataset[topicLi[i]] = 1;
		                			//topicTotal += 1;
		                		} else { // topic exists 
		                			dataset[topicLi[i]] += 1;
		                		}
		                	} // for
		                } // if
	                } 
	                // use opencalais metadata, which had been added additionally to 
	                // NYT articles
	                else {
		                var opencalais = item.opencalais;
		        		var topicLi = [];

		                // count num. of topics, keep docIDs from returned documents
		                if (typeof opencalais != 'undefined') {
		                	// deduplicate the duplicated opencalais topics
		                	topicLi = dedupe(opencalais.slice(1, -1).split('", "')); 
		                	// get a similarity score of a topic
		                	topicWeight = item.score;

		                	// ------- this is to compute local topic weights -----------
			               	for (var i=0; i < topicLi.length; i++) {
		                		//var topicElem = dataset[topicLi[i]];
		                		// adding a new topic
		                		if (!dataset[topicLi[i]]) {
		                			dataset[topicLi[i]] = 1;
		                			//topicTotal += 1;
		                		} else { // topic exists 
		                			dataset[topicLi[i]] += 1;
		                		}
		                		//console.log(topicLi[i] + ":" + dataset[topicLi[i]]);
		                	}

		                }

	                }
	    		});   // .each() 
            	// sort dataset in descending order of topic weights
            	for (var topic in dataset) {
            		sortedDataset.push([topic, dataset[topic]]);
            	}
            	sortedDataset.sort(function(a, b) {return b[1] - a[1] ;});
            	// make two array, one for unique topic list, the other for topic weights
            	for (var i=0; i < sortedDataset.length; i++) {
            		//console.log("sortedDataset: " + i + ":" + sortedDataset[i][0]);	
            		uniqueTopicLi.push(sortedDataset[i][0]);
            		uniqueWeightLi.push(sortedDataset[i][1]);
            	}
				// start d3 force-directed visualization -----(Force-Directed Start)-----
				// set up the size of visualization area
				var w = 746, h = 680;
				var labelDistance = 0;
				// add an svg element to use as a visualization area
				// var vis = d3.select("#visDiv").append("svg:svg").attr("width", w).attr("height", h);
				var nodes = [];
				var labelAnchors = [];
				var labelAnchorLinks = [];
				var links = [];
				// // select top N topics from the search result documents
				// var uniqueTopicLi_cut = uniqueTopicLi.slice(0,70);
				var topicBoxSizes = [];
				var visTopicLi = [];
				var visTopicLi_index = [];
				var visTopic_index_map = {};
				// var local_s_t_index_map = {};
				local_s_t_index_map = {};   // initialize map dic every time with new JSON
				
				var conti_i = 0;

				for(var i=0; i < uniqueTopicLi.length; i++) {
					var boxSize = 0;
					var topic = uniqueTopicLi[i];
					var topicLocalWeight = uniqueWeightLi[i];
					if (typeof numDocsObj[topic] != 'undefined') {
						// numDocs represents 'global' count
						numDocs = numDocsObj[topic]["numDocs"];						
					    // topicLocalWeight represent 'local' weighted count
						boxSize = topicLocalWeight * Math.log(83741/numDocs);
						// make a topic box size array
						topicBoxSizes.push(boxSize);
						// make a topic array
						visTopicLi.push(topic);
						// make a topic index array	
						visTopicLi_index.push(numDocsObj[topic]["index"]);
						visTopic_index_map[numDocsObj[topic]["index"]] = conti_i;					
						conti_i += 1;
					} 
					if (visTopicLi.length >= topic_max) {
						break;
					}					
				}				
				var maxBoxSize = Math.max.apply(null, topicBoxSizes);
				var tmpLi = topicBoxSizes;
				var tmpSize = 0;
				topicBoxSizes = [];
				// divide topicBox size with the max in the list (normalize)
				$.each(tmpLi, function (inde, d) {
					var normSize = d / maxBoxSize;
					// assign one of 4 box sizes to each topic
					// not uniform division, but three sizes if < 0.3
					if (normSize < 0.07) {
						tmpSize = 8;
					} else if ((normSize >= 0.07) && (normSize < 0.15)) {
						tmpSize = 16;
					} else if ((normSize >= 0.15) && (normSize < 0.3)) {
						tmpSize = 24;
					} else {
						tmpSize = 32;
					}
					topicBoxSizes.push(tmpSize);
				});
				console.log("visTopicLi: " + visTopicLi);
				console.log("visTopicLi size: " + visTopicLi.length);
				console.log("topicBoxSizes: " + topicBoxSizes);
				console.log("topicBoxSizes size: " + topicBoxSizes.length);

	    		// start visualization---------------------------------------------
	    		// var keyLi = Object.keys(dataset);
	     		// dataset_1 = keyLi.slice(0, 50);
	     		dataset_1 = visTopicLi.slice(0, 104);

			    // // Central x position
			    // var x_c =  w/2 - 30;
			    // // Central y position
			    // var y_c = h/2 - 30;
			    // x gap: distance btween x coordinates
			    var x_gap = 85;
			    // y gap: distance btween y coordinates
			    var y_gap = 50; 
			    $.each(dataset_1, function(i, item) {
			    	// item has a topic
			    	// box size
			    	var boxSize = topicBoxSizes[i]; 
			    	// compute variable boxWrapper width
			    	var boxWrapperWidth = 62 + boxSize;
			    	var topicShown = item;
			    	if (item.length > 30) {
			    		topicShown = topicShown.slice(0,30) + "...";
			    	}
			    	// compute x, y position, more relevant ones towards the top
			    	// less relevant ones towards the bottom
			    	var leftPos = x_gap * (i % 8) + 20;
			    	var topPos = y_gap * Math.floor(i / 8);
			    	$('#visDiv').append($('<div id="'+item+'" class="boxWrapper" style="top:' + topPos +'px;left:' + leftPos +'px;width:'+boxWrapperWidth+'px;"><div class="topicBox" style="width:' + boxSize+ 'px;height:' + boxSize+ 'px;"></div><div class="topicStr" id="topicStr_'+ item +'">' + topicShown + '</div></div>'));	
			    }); // .each()
		    
				// make 'Core' grid droppable (i.e., other elements can be dropped onto here)
				$("#parent1").droppable({
				    accept: ".topicStr",
				    //accept: ".node",
				    // drop: handleDropEvent
				    drop: handleDropEvent
				});

				// make the labels draggable, so they can be dragged and dropped onto Corel grids
	   		    $(".topicStr").draggable(
	    			{containment: ".ui-layout-west",	
	    			 opacity: 0.7,
	    			 // helper: clone,
	    			 helper: function(e, ui) {
	    			 	return $(this).clone().appendTo('body').show();
	    			 },
	    			 // distance: '20',
	    			 cursor: 'move'
	    		});
	  	
			  	// handles dropped elements for 'Core' grid
			   	function handleDropEvent( event, ui ) {
	    			var draggable = ui.draggable;
	    			// extract the id of dropped element
	    			var extId = draggable.attr('id');
	    			// extract the topic
	    			var draggableTopic = extId.split("_")[1];
	    			console.log("Dropped extId: " + extId);
	    			console.log("topic: " + draggableTopic);

	    			var sizedTopic = draggableTopic;
	    			// limit the text length to 30 characters
	    			if (sizedTopic.length >30) {
	    				sizedTopic = draggableTopic.slice(0,30) + "...";
	    			}     			
	    			
	    			// var droppableId = $(this).attr('id');
	    			$.each(["1_1","1_2","1_3","1_4","1_5","1_6"], function(i,d) {
	    					// add the label text to an empty Core grid from left
	    					// and change the grid cell color to lavender
	    					if ($("#"+d).text() == "") {
	    						$("#"+d).text(sizedTopic);
	    						$("#"+d).css("background-color", "lavender");
	    						return false;
	    					}    					
	    			;});
	    			// search Solr with the draggableText
	    			on_search(draggableTopic);
				}    
			}); // getJSON
		}
		
		// callback function to process returned JSON
		// this function is called by on_search()
        function on_data(data) {
        	// clean out the center pane to get ready for new doc list
            $('#results').empty();
            $('#totalNum').empty();
            // empty tetrisResult div
            $('#tetrisResults').empty();
            
	        // clear the #chickletResults pane
            $('#chickletResults').empty();
            $('#chickletResults').css("border", "1px solid gray");       	
            // extract queried topic from the returned results
            var topicQuery = data.responseHeader.params.q.split('"')[1];            

            // collect dropped topics in Corel (used later for tetris visualization)
			var corelTxtComb = "";
            $('.corelCell').each(function(i, d) {
            	corelTxtComb += $(d).text(); 
            });

            // access the 'docs' level, which is a list, of the JSON data
            var docs = data.response.docs;
			// visualize the topics as force-directed graph
            visualizeTopics_d3(docs);

	  		var openManFlag = "";
		    if ($('#manualRadio').attr('checked') == true) {
		    	openManFlag = "manual";
		    } else {
		    	openManFlag = "opencalais";
		    }
            
            // process Solr search results one by one
            $.each(docs, function(index, item) {
                if (openManFlag == "manual") {
	                // use 4 manual metadata fields from NYT article
	        		var descriptors = item.descriptors;
	        		var people = item.people;
	        		var locations = item.locations;
	        		var organizations = item.organizations;
	        		// arrays to hold entries from the 4 manual fields
	        		var topicLi = [];
	        		var descriptors_arr = [];
	        		var people_arr = [];
	        		var locations_arr = [];
	        		var organizations_arr = [];
	        		var merged_arr = [];
	        		// process only when the manual metadata field is not empty
	        		// and combine all 4 entries into a single 'merged_arr' array
	        		if ( descriptors != "") {
	        			merged_arr = $.merge([], descriptors.slice(1,-1).split('","'));
	        		}
	        		if ( people != "") {
	        			merged_arr = $.merge(merged_arr, people.slice(1,-1).split('","'));
	        		}
	        		if ( locations != "") {
	        			merged_arr = $.merge(merged_arr, locations.slice(1,-1).split('","'));
	        		}
	        		if ( organizations != "") {
	        			merged_arr = $.merge(merged_arr, organizations.slice(1,-1).split('","'));
	        		}
 
	                // count num. of topics, keep docIDs from returned documents
	                // if (typeof opencalais != 'undefined') {
	                if (merged_arr != []) {
	                	// deduplicate the topics in merged_arr
	                	topicLi = dedupe(merged_arr); 
	                } // if

                } else {
	                var opencalais = item.opencalais;
	        		var topicLi = [];

	                // count num. of topics, keep docIDs from returned documents
	                if (typeof opencalais != 'undefined') {
	                	// deduplicate the duplicated opencalais topics
	                	topicLi = dedupe(opencalais.slice(1, -1).split('", "')); 
	                }

                }

                // extract only the date portion from the timestamp
                var titleStr = item.titleText;
                if (typeof titleStr == 'undefined') {
                	titleStr = "No title provided";
                };
                // limit the title to 30 characters
                titleStr_sliced = titleStr.slice(0, 30);
                // if (item.titleText.length > 30) {
                if (titleStr.length > 30) {
                	titleStr_sliced += "...";
                };
                // process timestamp to get date and remove time
                var date = item.timestamp.split("T")[0];
                var sim_score = item.score;
                // source is hard-coded since we search only the NYT articles now
                var source = "NYT";
                //var dateSourceStr = date + "  |  " + source + " | " + item.score;
                var dateSourceStr = date + "  |  " + source + "   |   " + sim_score;
                var docID = item.id;

                // add title, date, source, and similarity score of articles 
                // to the center pane (more precisely into #results div)
                $('#results').append($('<div class="bar" id="' + docID + '"><div class="leftSubBar"><b>'  + titleStr_sliced + '</b><div class="dateSource">' + dateSourceStr + '</div></div><div class="barStat_r" id="barStat_r_' + docID + '"></div><div class="barStat_l"></div></div>'));

                if (barStat_r_dict[docID] != 'undefined') {
                	$('#barStat_r_' + docID).css("border", "1px solid " + barStat_r_dict[docID]);
                	$('#barStat_r_' + docID).css("background-color", barStat_r_dict[docID]);
                	$('#chickletResults').append('<div class="chicklet" id="chicklet_' + docID +'" style="background-color:' + barStat_r_dict[docID] + ';"></div>');
                }
                else {
                	$('#chickletResults').append('<div class="chicklet" id="chicklet_' + docID +'"></div>');

                }
                // tetris visualization starts here ----------------------------//

                // show tetris only when the Corel is not empty
                if (corelTxtComb != "") {
                	// add total 12 little boxes of tetris
	                $('#tetrisResults').append('<div class="rightBar"><div id="tet_'+index+'_1_1" class="tetrisCell"></div><div id="tet_'+index+'_1_2" class="tetrisCell"></div><div id="tet_'+index+'_1_3" class="tetrisCell"></div><div id="tet_'+index+'_1_4" class="tetrisCell"></div><div id="tet_'+index+'_1_5" class="tetrisCell"></div><div id="tet_'+index+'_1_6" class="tetrisCell"></div><div id="tet_'+index+'_2_1" class="tetrisCell"></div><div id="tet_'+index+'_2_2" class="tetrisCell"></div><div id="tet_'+index+'_2_3" class="tetrisCell"></div><div id="tet_'+index+'_2_4" class="tetrisCell"></div><div id="tet_'+index+'_2_5" class="tetrisCell"></div><div id="tet_'+index+'_2_6" class="tetrisCell"></div></div>');


	                // examine each 'Core' cells, and color tetris cells accordingly
	    			$.each(["1_1","1_2","1_3","1_4","1_5","1_6"], function(i,d) {
	    					var co_txt = $("#"+d).text();
	    					if (co_txt != "") {
		    					if ($.inArray(co_txt, topicLi.slice(0,20)) !== -1) {
		    					// if ($.inArray(co_txt, topicLi) !== -1) {
		    						$('#tet_' + index +'_'+d).css("background-color", 'darkblue');
		    						// $('#tet_' + index +'_'+d).css("border", '1px solid darkblue');
		    					} else {
		    						$('#tet_' + index +'_'+d).css("background-color", 'white');
		    						// $('#tet_' + index +'_'+d).css("border", '1px solid darkblue');

		    					}			

	    					}

	    			});
	    			// // examine each 'Related' cells, and color tetris cells accordingly
	    			// $.each(["2_1","2_2","2_3","2_4","2_5","2_6"], function(i,d) {
	    			// 		var rel_txt = $("#"+d).text();
	    			// 		if (rel_txt != "") {
		    		// 			if ($.inArray(rel_txt, topicLi.slice(0,20)) !== -1) {
		    		// 			// if ($.inArray(rel_txt, topicLi) !== -1) {
		    		// 				$('#tet_' + index +'_'+d).css("background-color", 'darkblue');
		    		// 				// $('#tet_' + index +'_'+d).css("border", '1px solid darkblue');
		    		// 			} else {
		    		// 				$('#tet_' + index +'_'+d).css("background-color", 'white');
		    		// 				// $('#tet_' + index +'_'+d).css("border", '1px solid darkblue');

		    		// 			}			

	    			// 		}
	    			// });
                	
                }

    			// tetris visualization ends here --------------------------------//


            }); // each
	
			// var queryTerm = $('#query').val();
            // var total = 'Total ' + docs.length + ' articles<br> Search term: ' + latestQuery;
            var total = 'Search term: ' + topicQuery + ' (' + docs.length + ' articles)';
            //console.log(total);

            // show search term with total num. of returned search results
            $('#totalNum').append('<div><b>' + total + '</b></div>');
            
            if (docs.length == 0) {
            	$('.ui-layout-center').css("background-color", "white");
            } else {
            	$('.ui-layout-center').css("background-color", "#DEDEDE");
            }                   
        }
  		// callback function to process returned JSON
  		// this function is called when a topic box or label is clicked
  		// no d3 graph visualization is provided in this function, which is the
  		// difference from on_data()
        function on_data_d_click(data) {
        	// clean up the center pane for new doc list
            $('#results').empty();
            $('#totalNum').empty();
            // empty tetrisResult div
            $('#tetrisResults').empty();
	        // clear the #chickletResults pane
            $('#chickletResults').empty();
            $('#chickletResults').css("border", "1px solid gray");       	


            // check if Corel has any topics (used later for tetris visualization)
			var corelTxtComb = "";
            $('.corelCell').each(function(i, d) {
            	corelTxtComb += $(d).text(); 
            });

            // extract queried topic from the returned results
            var topicQuery = data.responseHeader.params.q.split('"')[1];
            
            // access the 'docs' level, which is a list, of the JSON data
            var docs = data.response.docs;            

	  		var openManFlag = "";
		    if ($('#manualRadio').attr('checked') == true) {
		    	openManFlag = "manual";
		    } else {
		    	openManFlag = "opencalais";
		    }
            
            // process Solr search results one by one
            $.each(docs, function(index, item) {
                if (openManFlag == "manual") {
	                // use 4 manual metadata fields from NYT article
	        		var descriptors = item.descriptors;
	        		var people = item.people;
	        		var locations = item.locations;
	        		var organizations = item.organizations;
	        		// arrays to hold entries from the 4 manual fields
	        		var topicLi = [];
	        		var descriptors_arr = [];
	        		var people_arr = [];
	        		var locations_arr = [];
	        		var organizations_arr = [];
	        		var merged_arr = [];
	        		// process only when the manual metadata field is not empty
	        		// and combine all 4 entries into a single 'merged_arr' array
	        		if ( descriptors != "") {
	        			merged_arr = $.merge([], descriptors.slice(1,-1).split('","'));
	        		}
	        		if ( people != "") {
	        			merged_arr = $.merge(merged_arr, people.slice(1,-1).split('","'));
	        		}
	        		if ( locations != "") {
	        			merged_arr = $.merge(merged_arr, locations.slice(1,-1).split('","'));
	        		}
	        		if ( organizations != "") {
	        			merged_arr = $.merge(merged_arr, organizations.slice(1,-1).split('","'));
	        		}
 
	                // count num. of topics, keep docIDs from returned documents
	                // if (typeof opencalais != 'undefined') {
	                if (merged_arr != []) {
	                	// deduplicate the topics in merged_arr
	                	topicLi = dedupe(merged_arr); 
	                } // if

                } else {
	                var opencalais = item.opencalais;
	        		var topicLi = [];

	                // count num. of topics, keep docIDs from returned documents
	                if (typeof opencalais != 'undefined') {
	                	// deduplicate the duplicated opencalais topics
	                	topicLi = dedupe(opencalais.slice(1, -1).split('", "')); 
	                }

                }    
                // only extract the date portion from the timestamp
                var titleStr = item.titleText;
                // there were rare but some cases that the doc didn't have its title
                if (typeof titleStr == 'undefined') {
                	titleStr = "No title provided";
                };
                // limit the title to 30 characters
                titleStr_sliced = titleStr.slice(0, 30);
                if (titleStr.length > 30) {
                	titleStr_sliced += "...";
                };
                // extract only the date portion from the timestamp
                var date = item.timestamp.split("T")[0];
                var sim_score = item.score;
                // hard-code the source for now
                var source = "NYT";
                //var dateSourceStr = date + "  |  " + source + " | " + item.score;
                var dateSourceStr = date + "  |  " + source + "   |   " + sim_score;
                var docID = item.id;

                // add doc title, date, source, and similarity score to center pane
                $('#results').append($('<div class="bar" id="' + docID + '"><div class="leftSubBar"><b>'  + titleStr_sliced + '</b><div class="dateSource">' + dateSourceStr + '</div></div><div class="barStat_r" id="barStat_r_' + docID + '"></div><div class="barStat_l"></div></div>'));

                // chicklet visualization starts here ------------------------------//
                if (barStat_r_dict[docID] != 'undefined') {
                	$('#barStat_r_' + docID).css("border", "1px solid " + barStat_r_dict[docID]);
                	$('#barStat_r_' + docID).css("background-color", barStat_r_dict[docID]);
                	$('#chickletResults').append('<div class="chicklet" id="chicklet_' + docID +'" style="background-color:' + barStat_r_dict[docID] + ';"></div>');
                }
                else {
                	$('#chickletResults').append('<div class="chicklet" id="chicklet_' + docID +'"></div>');

                }
                // chicklet visualization ends here --------------------------------//

                // tetris visualization starts here --------------------------------//
	                // unless the Corel is empty, create a tetris visualization
	                if (corelTxtComb != "") {
	                	// add 12 little boxes of a tetris 
		                $('#tetrisResults').append('<div class="rightBar"><div id="tet_'+index+'_1_1" class="tetrisCell"></div><div id="tet_'+index+'_1_2" class="tetrisCell"></div><div id="tet_'+index+'_1_3" class="tetrisCell"></div><div id="tet_'+index+'_1_4" class="tetrisCell"></div><div id="tet_'+index+'_1_5" class="tetrisCell"></div><div id="tet_'+index+'_1_6" class="tetrisCell"></div><div id="tet_'+index+'_2_1" class="tetrisCell"></div><div id="tet_'+index+'_2_2" class="tetrisCell"></div><div id="tet_'+index+'_2_3" class="tetrisCell"></div><div id="tet_'+index+'_2_4" class="tetrisCell"></div><div id="tet_'+index+'_2_5" class="tetrisCell"></div><div id="tet_'+index+'_2_6" class="tetrisCell"></div></div>');


		                // examine 'Core' grid and color the tetris cells accordingly
		    			$.each(["1_1","1_2","1_3","1_4","1_5","1_6"], function(i,d) {
		    					var co_txt = $("#"+d).text();
		    					if (co_txt != "") {
			    					if ($.inArray(co_txt, topicLi.slice(0,20)) !== -1) {
			    					// if ($.inArray(co_txt, topicLi) !== -1) {
			    						$('#tet_' + index +'_'+d).css("background-color", 'darkblue');
			    						// $('#tet_' + index +'_'+d).css("border", '1px solid darkblue');
			    					} else {
			    						$('#tet_' + index +'_'+d).css("background-color", 'white');
			    						// $('#tet_' + index +'_'+d).css("border", '1px solid darkblue');

			    					}			

		    					}

		    			});
		    			// examine 'Related' grid and color the tetris cells accordingly
		    			$.each(["2_1","2_2","2_3","2_4","2_5","2_6"], function(i,d) {
		    					var rel_txt = $("#"+d).text();
		    					if (rel_txt != "") {
			    					if ($.inArray(rel_txt, topicLi.slice(0,20)) !== -1) {
			    					// if ($.inArray(rel_txt, topicLi) !== -1) {
			    						$('#tet_' + index +'_'+d).css("background-color", 'darkblue');
			    						// $('#tet_' + index +'_'+d).css("border", '1px solid darkblue');
			    					} else {
			    						$('#tet_' + index +'_'+d).css("background-color", 'white');
			    						// $('#tet_' + index +'_'+d).css("border", '1px solid darkblue');

			    					}			

		    					}
		    			});
	                	
	                }

	    			// tetris visualization ends here --------------------------------//

            }); // each

            // var total = 'Total ' + docs.length + ' articles<br> Topic: ' + topicQuery;
            var total = 'Topic: ' + topicQuery + ' (' + docs.length + ' articles)';

            // add the topic label and the total number of search results from Solr
            $('#totalNum').append('<div><b>' + total + '</b></div>');
            
            if (docs.length == 0) {
            	$('.ui-layout-center').css("background-color", "white");
            } else {
            	$('.ui-layout-center').css("background-color", "#DEDEDE");
            }
                      
        }

        // using the topics dropped onto Corel, this function queries to Solr
        // returned result is processed and the documents are listed in the center pane
        // result is also visualized as d3 graph, by calling on_data_regraph() function
        function on_regraph() {
        	// show check makr in the 'regraph' square radio button 
        	$('#regraphRadio').attr("checked", "true");
        	// scroll up the center pane
        	$('#centerOuter').animate({scrollTop: 0}, 'fast');
        	// clean up the doc content viewer 
        	$('#topBoxEast').empty();
        	$('#singleText').empty();
            var numTopics = $('#numTopics').val();
            topic_max = numTopics;
            // console.log("numTopics:(from box) " + numTopics);
            var articlesToList = $('#articlesToList').val();
            // console.log("articlesToList:(from box) " + articlesToList);
            var relatedTopicsCut = $('#relatedTopicsCut').val();
            // console.log("relatedTopicsCut:(from box) " + relatedTopicsCut);
            
            // var query = $('#query').val();

            // collect all the text in COREL
            var combinedCorel = "";
            $('.corelCell').each(function(i, d) {
            	// console.log("cell text: " + $(d).text()) ;
            	var ext_text = $(d).text();
            	if (ext_text != "") {
	            	// combinedCorel = combinedCorel + 'opencalais:"' + $(d).text() + '" AND '; 
	            	combinedCorel = combinedCorel + 'descriptors="' + $(d).text() + ' OR organizations="' + $(d).text() + ' OR locations="' + $(d).text() + ' OR people="' + $(d).text() + '" AND '; 
	            }
            });
            combinedCorel = combinedCorel.slice(0,-5);
            // console.log(combinedCorel);



            if (combinedCorel.length == 0) {
            	// console.log("combinedCorel is empty");
                return;
            }
            // find the total number of results
            var url_result_count = 'http://solr_server_hostname:solr_server_port/solr/select/?wt=json&json.wrf=?&' +
                    'q=(' + combinedCorel + ') AND (opencalais:* AND source:NYT)&fl=score&rows=0';
            $.ajax({
            	type: 'GET',
            	url: url_result_count,
            	dataType: 'json',
            	success: function(data) {
            		var result_count = data.response.numFound;
		            var url='http://solr_server_hostname:solr_server_port/solr/select/?wt=json&json.wrf=?&' +
                    'q=(' + combinedCorel + ') AND (opencalais:* AND source:NYT)&fl=score&rows=' + (Math.round(result_count*articlesToList*0.01)).toString();
		            $.getJSON(url, on_data_regraph);
            	},
            	async: false
            });      
        }
 
 		// this function is called when 'Clear Corel' button is clicked
 		// it removes the dropped topics in Corel
        function on_removeTopics() {
            $('.corelCell').each(function(i, d) {
            	// console.log("cell text: " + $(d).text()) ;
            	$(d).text("");
            	$(d).css("background-color", "transparent");
            });         
        }

        // this function is called when the search button is clicked
        // it visualizes the topic graph based on the search result
        function on_search(query) {
        	// show check makr in the 'search' square radio button
        	// $('#searchRadio').attr("checked", "true");
        	// scroll up the document list pane in the center
        	$('#centerOuter').animate({scrollTop: 0}, 'fast');
        	// clean up the document content view pane
        	$('#topBoxEast').empty();
        	$('#singleText').empty();
            var numTopics = $('#numTopics').val();
            topic_max = numTopics;
            // console.log("numTopics:(from box) " + numTopics);
            var articlesToList = $('#articlesToList').val();
            // console.log("articlesToList:(from box) " + articlesToList);
            var relatedTopicsCut = $('#relatedTopicsCut').val();
            // console.log("relatedTopicsCut:(from box) " + relatedTopicsCut);
            // var query = $('#query').val();

            if (query.length == 0) {
                return;
            }
            // query solr with no actual documents, but to get the number of documents
            var url_result_count = 'http://solr_server_hostname:solr_server_port/solr/select/?wt=json&json.wrf=?&' +
		                    'q=(descriptors:"' + query + '" OR organizations:"' + query + '" OR locations:"' + query + '" OR people:"' + query + '") AND (source:NYT AND opencalais:*)&fl=score&rows=0';

		                    
            $.ajax({
            	type: 'GET',
            	url: url_result_count,
            	dataType: 'json',
            	success: function(data) {
            		var result_count = data.response.numFound;
		            // var url='http://solr_server_hostname:solr_server_port/solr/select/?wt=json&json.wrf=?&' +
		            //         'q=opencalais:"' + query + '" AND source:NYT&fl=score&rows=' + (Math.round(result_count*articlesToList*0.01)).toString();

		            // query solr to get the actual documents
		            // number of results is adjusted based on the configuration parameters
		            var url='http://solr_server_hostname:solr_server_port/solr/select/?wt=json&json.wrf=?&' +
		                    'q=(descriptors:"' + query + '" OR organizations:"' + query + '" OR locations:"' + query + '" OR people:"' + query + '") AND (source:NYT AND opencalais:*)&fl=score&rows=' + (Math.round(result_count*articlesToList*0.01)).toString();
		            // on_data() is called to process the returned result from Solr
		            $.getJSON(url, on_data);
            	},
            	async: false

            });
         
        }
        // this function fires when a topic box or a label is clicked
        function on_search_d_click(topic) {
        	// show check makr in the 'search' square radio button
        	$('#topicRadio').attr("checked", "true");
        	// scroll up the center pane
        	$('#centerOuter').animate({scrollTop: 0}, 'fast');
        	// clean up the document content view pane
        	$('#topBoxEast').empty();
        	$('#singleText').empty();
            //var query = $('#query').val();
            if (topic.length == 0) {
                return;
            }

            var numTopics = $('#numTopics').val();
            topic_max = numTopics;
            
            var articlesToList = $('#articlesToList').val();
            var relatedTopicsCut = $('#relatedTopicsCut').val();
            // var query = $('#query').val();
            // if (query.length == 0) {
            //     return;
            // }
            // find the total number of results by querying Solr
            // no actual documents are returned this time
            var url_result_count = 'http://solr_server_hostname:solr_server_port/solr/select/?wt=json&json.wrf=?&' +
		                    'q=(descriptors:"' + topic + '" OR organizations:"' + topic + '" OR locations:"' + topic + '" OR people:"' + topic + '") AND (source:NYT AND opencalais:*)&fl=score&rows=0';
            $.ajax({
            	type: 'GET',
            	url: url_result_count,
            	dataType: 'json',
            	success: function(data) {
            		var result_count = data.response.numFound;
            		// query Solr and get the actual documents as result
		            var url='http://solr_server_hostname:solr_server_port/solr/select/?wt=json&json.wrf=?&' +
		                    'q=(descriptors:"' + topic + '" OR organizations:"' + topic + '" OR locations:"' + topic + '" OR people:"' + topic + '") AND (source:NYT AND opencalais:*)&fl=score&rows=' + (Math.round(result_count*articlesToList*0.01)).toString();
		            // call on_data_d_click() to process the returned result
		            $.getJSON(url, on_data_d_click);
            	},
            	async: false

            });
         
        }

        // wait for the buttons and elements to be clicked
        function on_ready() {
            // calls on_search() when the 'Search' button is clicked
            $('#search').click(on_search);
            // calls on_regraph() when the 'Regraph' button is clicked
            $('#regraph').click(on_regraph);
            // calls on_removeTopics() when the 'Clear Corel' button is clicked
            $('#removeTopics').click(on_removeTopics);
            
            // /* Hook enter key to search */
            // $('body').keypress(function(e) {
            //     if (e.keyCode == '13') {
            //         on_search();
            //     }
            // });
            $('.corelCell').keypress(function(e) {
                if (e.keyCode == '13'  || event.charCode == '13') {
                	console.log("editable div text: " + $(this).text());
               		console.log("editable div id: " + $(this).attr("id"));
               		latestQuery = $(this).text();
               		var tmpId = $(this).attr("id");
               		$('#'+tmpId).css("background-color", "lavender");
                    on_search(latestQuery);
                }
            });

            
            // Be sure to use 'live' to make generated div clickable
            // Below are actions to do when a node box is clicked
			// $("rect.node").live("click", function(){
			$(".topicBox").live("click", function(){
				// find previously clicked node and update its color to blue
				// if (prevClickedNodeId != "") {
				// 	$('#' + prevClickedNodeId).css("fill", "SteelBlue");	
				// 	$('#' + prevClickedNodeId).css("stroke", "Blue");	
				// }				
				// prevClickedNodeId = $(this).attr("id");
				var ext_id = $(this).attr("id");
				// var related_topic_index = local_s_t_index_map[ext_id];
				// // update the graph if the size of related_topic_index is not 0
				// if (related_topic_index.length != 0) {

				// 	$('rect.node').each(function(i, d) {
				// 		// color all yellow nodes to blue
				// 		if ($(d).css("fill") == "#ffd700") {  // #ffd700 is yellow
				// 			$(d).css("fill", "SteelBlue");
				// 			$(d).css("stroke", "Blue");
				// 		}
				// 	;});				

				// 	// to visualize entire related topics
				// 	// $.each(related_topic_index, function(d) {
				// 	// to visualize top 20 most related topics
				// 	$.each(related_topic_index.slice(0,20), function(d) {
				// 			$('#'+d).css("fill", "gold");
				// 			$('#'+d).css("stroke", "orange");
				// 			$('#label_'+d).css("fill", "black");
				// 	;});
				// 	// color the clicked box orange
		  //    		$(this).css("fill", "orange");
		  //    		// color the border of the clicked box red
				// 	$(this).css("stroke", "red");
				// 	// $(".labelText#" + label_id).css("fill", "black");
				// 	// color the label of the box to black 
				// 	// this is to expose a hidden label of a gray box
				// 	$("#label_" + ext_id).css("fill", "black");	

				// 	var labelTxt = $("#label_" + ext_id).text();
					on_search_d_click(ext_id);
				// }
			});

            // Be sure to use 'live' to make generated div clickable
            // Below are actions to do when a topic label is clicked
			$(".topicStr").live("click", function(){
				// console.log("old prev node id: " + prevClickedNodeId);
				// if (prevClickedNodeId != "") {
				// 	$('#' + prevClickedNodeId).css("fill", "SteelBlue");	
				// 	$('#' + prevClickedNodeId).css("stroke", "Blue");	
				// }				
				var tempPrevNode = $(this).attr("id");
				prevClickedNodeId = tempPrevNode.split('_')[1];
				
				// console.log("prev node id (from box click): " + prevClickedNodeId);
				var ext_id = $(this).attr("id").split('_')[1];
				//$('#'+ (parseInt(ext_id)*2+1)).css("fill", "black");

				// var related_topic_index = local_s_t_index_map[ext_id];

				// $('rect.node').each(function(i, d) {
				// 	// color all the yellow nodes to blue
				// 	if ($(d).css("fill") == "#ffd700") {  // #ffd700 is yellow
				// 		$(d).css("fill", "SteelBlue");
				// 		$(d).css("stroke", "Blue");
				// 	}
				// ;});				

				// // color top 20 of a clicked node's related topics to orange
				// $.each(related_topic_index.slice(0,20), function(d) {

				// 		$('#'+d).css("fill", "gold");
				// 		$('#'+d).css("stroke", "orange");
				// 		$('#label_'+d).css("fill", "black");

				// ;});
				// // color clicked lable's box to orange
	   //   		$('#'+ext_id).css("fill", "orange");
	   //   		// and color its border to red
				// $('#'+ext_id).css("stroke", "red");
				// // and expose the label by coloring it black
				// $("#label_" + ext_id).css("fill", "black");

				// var labelTxt = $(this).text();
				// // call on_search_d_click() to retrieve documents that match
				// // the topic label, and update the document list view pane
				on_search_d_click(ext_id);

			});

			$("div.barStat_r").live("click", function() {

				// console.log("clicked div color:" + $(this).css("background-color"));
				// from steelblue to darkred
				if ($(this).css("background-color") == "rgb(176, 196, 222)") {
					$(this).css("border", "1px solid darkred");
					$(this).css("background-color", "darkred");
					// add the docID and its corresponding barStat_r color
					// console.log("id ext: " + $(this).attr("id"));
					var tmpar = $(this).attr("id").split('_');
					// console.log("tmpar: " + tmpar[2]);
					barStat_r_dict[tmpar[2]] = "darkred";
					$('#chicklet_'+tmpar[2]).css("border", "1px solid darkred");
					$('#chicklet_'+tmpar[2]).css("background-color", "darkred");

				}
				// from darkred to green
				else if ($(this).css("background-color") == "rgb(139, 0, 0)") {
					$(this).css("border", "1px solid green");
					$(this).css("background-color", "green");
					var tmpar = $(this).attr("id").split('_');
					// console.log("tmpar: " + tmpar[2]);
					barStat_r_dict[tmpar[2]] = "green";
					$('#chicklet_'+tmpar[2]).css("border", "1px solid green");
					$('#chicklet_'+tmpar[2]).css("background-color", "green");

				}
				// from green to steelblue
				else if ($(this).css("background-color") == "rgb(0, 128, 0)"){
					$(this).css("border", "1px solid lightsteelblue");
					$(this).css("background-color", "lightsteelblue");
					var tmpar = $(this).attr("id").split('_');
					// console.log("tmpar: " + tmpar[2]);
					barStat_r_dict[tmpar[2]] = "lightsteelblue";
					$('#chicklet_'+tmpar[2]).css("border", "1px solid lightsteelblue");
					$('#chicklet_'+tmpar[2]).css("background-color", "lightsteelblue");

				} 
				else {
					console.log("else statement in div.barStat_r");
				}	

				// $.each(barStat_r_dict, function(i, d) {
				// 	console.log("barStat elem: " + d);
				// });

				// console.log("non existing docID in barStat: " + barStat_r_dict["4395874"]);
				


			});

            // Be sure to use 'live' to make generated div clickable
            // actions to do when a document bar (i.e., div that has title, date, source) is clicked in the doc list view pane
			$("div.bar").live("click", function(){
				// scroll up the document content view pane
				$('#singleText').animate({scrollTop: 0}, 'fast');
				// change border color of the clicked document bar to orange
				// to do that, first, color all the doc bar borders to black
				// and then color the clicked bar's border to orange
	     		$(".bar").css("border", "1px solid black");
	     		$(this).css("border", "1px solid orange");
	     		$(".chicklet").css("border", "1px solid #DEDEDE");
	     		// extract id of the clicked div
	     		var docID = $(this).attr('id');
	     		//construct an API query for single doc json data
	     		var url_single_doc = 'http://solr_server_hostname:solr_server_port/solr/select?wt=json&json.wrf=?&q=id:' + docID;

		  		var openManFlag = "";
		  		// check whether manual radio or opencalais radio button is checked
			    if ($('#manualRadio').attr('checked') == true) {
			    	openManFlag = "manual";
			    } else {
			    	openManFlag = "opencalais";
			    }


	     		// process the results from Solr one by one
	     		$.getJSON(url_single_doc, function(data) {
	     		 	var docs = data.response.docs;
	     		 	var titleText = docs[0].titleText;
	     		 	var date = docs[0].timestamp.split("T")[0];
	     		 	var src = docs[0].source;
	     		 	var opencalais = docs[0].opencalais;

	     		 	// extract values from 4 manual metadata fields to show in
	     		 	// document content pane
	     		 	var descriptors = docs[0].descriptors;
	     		 	var organizations = docs[0].organizations;
	     		 	var locations = docs[0].locations;
	     		 	var people = docs[0].people;

	     		 	var contentText = docs[0].text;
	     		 	var contentWithBreaks = contentText.replace(/\n/g, '<br /><br />');
	     		 	var topicLi = [];
	     		 	var merged_arr = [];

	     		 	// clean up the top portion of doc content view pane
	     		 	// to show a new document title
	     		 	$('#topBoxEast').empty();
	     		 	// add the title of the clicked document to blue top box
	     		 	$('#topBoxEast').append('<p>' + titleText +'</p>');
	     		 	// $('#topBoxEast').append('<p><div class="dateSource" style="color:white;">' + date + '</div></p>');	  

	     		 	// add date to the blue top box
	     		 	$('#topBoxEast').append('<p><div class="dateSource" style="color:white;">' + date + '</div></p>');	     		 	
	     		 	// clean up where the doc content is viewed
	     		 	$('#singleText').empty();	

	     		 	if (openManFlag == "manual") {
		     		 	// add 4 manual metadata values on top of the document content
						$('#singleText').append('<p>---- [Descriptors] ------------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + descriptors + '<br><br></p>');
						$('#singleText').append('<p>---- [Organizations] ----------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + organizations + '<br><br></p>');
						$('#singleText').append('<p>---- [Locations] -----------------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + locations + '<br><br></p>');
						$('#singleText').append('<p>---- [People] ----------------------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + people + '<br><br></p>');

						$('#singleText').append('<p>--------------------------------------------------------------------------------------</p>');
						// add the document content
		     		 	$('#singleText').append('<p>' + contentWithBreaks + '</p>');

		        		// var descriptors_arr = [];
		        		// var people_arr = [];
		        		// var locations_arr = [];
		        		// var organizations_arr = [];
		        		
	 					// unless the field value is empty, add its content to a merged array
		        		if ( descriptors != "") {
		        			merged_arr = $.merge([], descriptors.slice(1,-1).split('","'));
		        		}
		        		if ( people != "") {
		        			merged_arr = $.merge(merged_arr, people.slice(1,-1).split('","'));
		        		}
		        		if ( locations != "") {
		        			merged_arr = $.merge(merged_arr, locations.slice(1,-1).split('","'));
		        		}
		        		if ( organizations != "") {
		        			merged_arr = $.merge(merged_arr, organizations.slice(1,-1).split('","'));
		        		}

	     		 	}
	     		 	else {
						$('#singleText').append('<p>---- [OpenCalais Topics] ------------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + opencalais + '<br><br></p>');

						$('#singleText').append('<p>------------------------------------------------------------------------------------------------</p>');
															    		 
		     		 	$('#singleText').append('<p>' + contentWithBreaks + '</p>');

		                if (typeof opencalais != 'undefined') {
		                	// get top 20 topics
		                	merged_arr = opencalais.slice(1, -1).split('", "');
		                }
	     		 	}

	                if (merged_arr != []) {
	                	// get top 20 topics, after deduplicating the merged array
	                	// Note:
	                	// duplicated items didn't happen often for manual metadata,
	                	// but they appeared quite often for the opencalais metadata
	                	topicLi = dedupe(merged_arr).slice(0,20);
	                	// color previously-clicked node, which is in orange, to blue
	                	// since now it became a 'visited' item
						if (prevClickedNodeId != "") {
							$('#' + prevClickedNodeId).css("fill", "SteelBlue");	
							$('#' + prevClickedNodeId).css("stroke", "Blue");	
						}

						$('rect.node').each(function(i, d) {
							// color all yellow nodes to blue
							if ($(d).css("fill") == "#ffd700") {  // #ffd700 is yellow
								$(d).css("fill", "SteelBlue");
								$(d).css("stroke", "Blue");
							}
						;});				

						// initialize prevRelated_topic_index to an empty array
						// prevRelated_topic_index = [];
						for (var item=0; item < topicLi.length; item++) {
							// find all the label ids if that label text matches
							// one of the clicked document's topic (from one of 
							// 4 metadata field values)
							// console.log("labelText contains:" + topicLi[item] + ":");

							if (topicLi[item] != "") {
								var labelID = $('.labelText:contains('+ topicLi[item] +')').attr('id');
								// process the label id to find the corresponding
								// node's id, then color the node box to orange
								if (typeof labelID != 'undefined') {
									var processedID = labelID.split('_')[1];
									$('#'+processedID).css('fill', 'gold');	
									$('#'+processedID).css('stroke', 'orange');	
									$('#'+labelID).css('fill', 'black');	

								}
							}

						}

	                } // if
	     		 	
	     		}); // getJSON

			});
            // Be sure to use 'live' to make generated div clickable
            // Below are actions to do when a node box is clicked
			$(".chicklet").live("click", function(){
				// color the border orange after coloring other chiclet borders to white
				$(".chicklet").css("border", "1px solid #DEDEDE");
				$(this).css("border", "1px solid orange");
				$(".bar").css("border", "1px solid black");
				
	     		// extract id of the clicked div
	     		var tmpID = $(this).attr('id');
	     		console.log("tmpID: " + tmpID);
	     		var docID = tmpID.split('_')[1];
	     		console.log("docID: " + docID);
	     		//construct an API query for single doc json data
	     		var url_single_doc = 'http://solr_server_hostname:solr_server_port/solr/select?wt=json&json.wrf=?&q=id:' + docID;

		  		var openManFlag = "";
		  		// check whether manual radio or opencalais radio button is checked
			    if ($('#manualRadio').attr('checked') == true) {
			    	openManFlag = "manual";
			    } else {
			    	openManFlag = "opencalais";
			    }


	     		// process the results from Solr one by one
	     		$.getJSON(url_single_doc, function(data) {
	     		 	var docs = data.response.docs;
	     		 	var titleText = docs[0].titleText;
	     		 	var date = docs[0].timestamp.split("T")[0];
	     		 	var src = docs[0].source;
	     		 	var opencalais = docs[0].opencalais;

	     		 	// extract values from 4 manual metadata fields to show in
	     		 	// document content pane
	     		 	var descriptors = docs[0].descriptors;
	     		 	var organizations = docs[0].organizations;
	     		 	var locations = docs[0].locations;
	     		 	var people = docs[0].people;

	     		 	var contentText = docs[0].text;
	     		 	var contentWithBreaks = contentText.replace(/\n/g, '<br /><br />');
	     		 	var topicLi = [];
	     		 	var merged_arr = [];

	     		 	// clean up the top portion of doc content view pane
	     		 	// to show a new document title
	     		 	$('#topBoxEast').empty();
	     		 	// add the title of the clicked document to blue top box
	     		 	$('#topBoxEast').append('<p>' + titleText +'</p>');
	     		 	// $('#topBoxEast').append('<p><div class="dateSource" style="color:white;">' + date + '</div></p>');	  

	     		 	// add date to the blue top box
	     		 	$('#topBoxEast').append('<p><div class="dateSource" style="color:white;">' + date + '</div></p>');	     		 	
	     		 	// clean up where the doc content is viewed
	     		 	$('#singleText').empty();	

	     		 	if (openManFlag == "manual") {
		     		 	// add 4 manual metadata values on top of the document content
						$('#singleText').append('<p>---- [Descriptors] ------------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + descriptors + '<br><br></p>');
						$('#singleText').append('<p>---- [Organizations] ----------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + organizations + '<br><br></p>');
						$('#singleText').append('<p>---- [Locations] -----------------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + locations + '<br><br></p>');
						$('#singleText').append('<p>---- [People] ----------------------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + people + '<br><br></p>');

						$('#singleText').append('<p>--------------------------------------------------------------------------------------</p>');
						// add the document content
		     		 	$('#singleText').append('<p>' + contentWithBreaks + '</p>');

		        		// var descriptors_arr = [];
		        		// var people_arr = [];
		        		// var locations_arr = [];
		        		// var organizations_arr = [];
		        		
	 					// unless the field value is empty, add its content to a merged array
		        		if ( descriptors != "") {
		        			merged_arr = $.merge([], descriptors.slice(1,-1).split('","'));
		        		}
		        		if ( people != "") {
		        			merged_arr = $.merge(merged_arr, people.slice(1,-1).split('","'));
		        		}
		        		if ( locations != "") {
		        			merged_arr = $.merge(merged_arr, locations.slice(1,-1).split('","'));
		        		}
		        		if ( organizations != "") {
		        			merged_arr = $.merge(merged_arr, organizations.slice(1,-1).split('","'));
		        		}

	     		 	}
	     		 	else {
						$('#singleText').append('<p>---- [OpenCalais Topics] ------------------------------------------------------</p>');

		     		 	$('#singleText').append('<p>' + opencalais + '<br><br></p>');

						$('#singleText').append('<p>------------------------------------------------------------------------------------------------</p>');
															    		 
		     		 	$('#singleText').append('<p>' + contentWithBreaks + '</p>');

		                if (typeof opencalais != 'undefined') {
		                	// get top 20 topics
		                	merged_arr = opencalais.slice(1, -1).split('", "');
		                }
	     		 	}

	                if (merged_arr != []) {
	                	// get top 20 topics, after deduplicating the merged array
	                	// Note:
	                	// duplicated items didn't happen often for manual metadata,
	                	// but they appeared quite often for the opencalais metadata
	                	topicLi = dedupe(merged_arr).slice(0,20);
	                	// color previously-clicked node, which is in orange, to blue
	                	// since now it became a 'visited' item
						if (prevClickedNodeId != "") {
							$('#' + prevClickedNodeId).css("fill", "SteelBlue");	
							$('#' + prevClickedNodeId).css("stroke", "Blue");	
						}

						$('rect.node').each(function(i, d) {
							// color all yellow nodes to blue
							if ($(d).css("fill") == "#ffd700") {  // #ffd700 is yellow
								$(d).css("fill", "SteelBlue");
								$(d).css("stroke", "Blue");
							}
						;});				

						// initialize prevRelated_topic_index to an empty array
						// prevRelated_topic_index = [];
						for (var item=0; item < topicLi.length; item++) {
							// find all the label ids if that label text matches
							// one of the clicked document's topic (from one of 
							// 4 metadata field values)
							// console.log("labelText contains:" + topicLi[item] + ":");

							if (topicLi[item] != "") {
								var labelID = $('.labelText:contains('+ topicLi[item] +')').attr('id');
								// process the label id to find the corresponding
								// node's id, then color the node box to orange
								if (typeof labelID != 'undefined') {
									var processedID = labelID.split('_')[1];
									$('#'+processedID).css('fill', 'gold');	
									$('#'+processedID).css('stroke', 'orange');	
									$('#'+labelID).css('fill', 'black');	

								}
							}

						}

	                } // if
	     		 	
	     		}); // getJSON
			}); // chicklet.live


        }
    // make sure the tool starts working (i.e., clicking things, searching, etc.)
    // once all the html has been downloaded.  Without this, the tool may not work
    // as expected because a feature might try to interact with other components when
    // that components are not yet downloaded to user's web browser
    $(document).ready(on_ready);

	</script>

</div>

</body>
</html>